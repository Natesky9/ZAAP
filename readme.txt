Complete rewrite of multiplayer code